name: Build and deploy docs

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "deploy"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Build docs agent widget
        run: |
          cd widget
          npm ci
          npm run build

      - name: Install mdBook
        run: |
          MDBOOK_VERSION='v0.5.2'
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/${MDBOOK_VERSION}/mdbook-${MDBOOK_VERSION}-x86_64-unknown-linux-gnu.tar.gz | tar -xz
          sudo mv mdbook /usr/local/bin/mdbook

      - name: Install mdbook-tabs
        run: |
          cargo install mdbook-tabs --version 0.3.4
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Build all books
        run: ./build.sh

      - name: Generate llms.txt
        run: |
          cd scripts
          npm ci
          npm run generate-llms-txt

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DOCS_DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H start9.com >> ~/.ssh/known_hosts
          cat >> ~/.ssh/config <<EOF
          Host docs-vps
            HostName start9.com
            User root
            IdentityFile ~/.ssh/deploy_key
            IdentitiesOnly yes
          EOF

      - name: Deploy to VPS
        run: |
          source versions.conf
          DEST="/var/www/html/docs.start9.com"

          # Sync each book's versioned directory
          rsync -az --delete docs/start-os/$START_OS_VERSION/ docs-vps:$DEST/start-os/$START_OS_VERSION/
          rsync -az --delete docs/start-tunnel/$START_TUNNEL_VERSION/ docs-vps:$DEST/start-tunnel/$START_TUNNEL_VERSION/
          rsync -az --delete docs/packaging/$PACKAGING_VERSION/ docs-vps:$DEST/packaging/$PACKAGING_VERSION/

          # Sync per-book llms.txt into versioned directories (unversioned URLs redirect here)
          rsync -az docs/start-os/llms.txt docs/start-os/llms-full.txt docs-vps:$DEST/start-os/$START_OS_VERSION/
          rsync -az docs/start-tunnel/llms.txt docs/start-tunnel/llms-full.txt docs-vps:$DEST/start-tunnel/$START_TUNNEL_VERSION/
          rsync -az docs/packaging/llms.txt docs/packaging/llms-full.txt docs-vps:$DEST/packaging/$PACKAGING_VERSION/

          # Sync landing page and global llms.txt files
          rsync -az docs/index.html docs-vps:$DEST/index.html
          rsync -az docs/llms.txt docs/llms-full.txt docs-vps:$DEST/

      - name: Generate and upload nginx book_versions.conf
        run: |
          source versions.conf

          cat > book_versions.conf <<'NGINX'
          # Auto-generated by deploy workflow â€” do not edit manually

          # Extract book name from URI
          map $uri $book_name {
              default "";
              ~^/(start-os|start-tunnel|packaging|start-wrt)(/|$) $1;
          }

          # Latest version per book
          map $book_name $latest_book_version {
              default "";
          NGINX

          echo "    \"start-os\" \"$START_OS_VERSION\";" >> book_versions.conf
          echo "    \"start-tunnel\" \"$START_TUNNEL_VERSION\";" >> book_versions.conf
          echo "    \"packaging\" \"$PACKAGING_VERSION\";" >> book_versions.conf

          cat >> book_versions.conf <<'NGINX'
          }

          # Version resolution: maps book + ?version= param to directory name
          NGINX

          echo 'map "$book_name:$arg_version" $resolved_book_version {' >> book_versions.conf
          echo '    default "";' >> book_versions.conf
          echo "    \"~^start-os:0\\.4\\.0(\\.|$)\" \"$START_OS_VERSION\";" >> book_versions.conf
          echo "    \"~^start-tunnel:1\\.0(\\.|$)\" \"$START_TUNNEL_VERSION\";" >> book_versions.conf
          echo "    \"~^packaging:0\\.4\\.0(\\.|$)\" \"$PACKAGING_VERSION\";" >> book_versions.conf
          echo "}" >> book_versions.conf

          rsync -az book_versions.conf docs-vps:/etc/nginx/includes/book_versions.conf

      - name: Reload nginx
        run: ssh docs-vps 'nginx -t && nginx -s reload'
